<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Kas Masjid Cloud</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; }
        .active-tab { color: #10b981; border-top: 2px solid #10b981; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 pb-24 lg:pb-0 lg:pl-64">

    <!-- Sidebar & Navigasi (Sama seperti sebelumnya) -->
    <aside class="hidden lg:flex fixed left-0 top-0 bottom-0 w-64 bg-emerald-900 text-white flex-col p-6 no-print">
        <div class="flex items-center gap-3 mb-10">
            <div class="w-8 h-8 bg-emerald-400 rounded-lg flex items-center justify-center">
                <i data-lucide="mosque" class="text-emerald-900" size="20"></i>
            </div>
            <h1 class="font-bold text-lg leading-tight uppercase">Kas<br/><span class="text-emerald-400">Masjid</span></h1>
        </div>
        <nav class="space-y-2 flex-1">
            <button onclick="switchTab('dashboard')" class="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-white/10 transition-all font-medium text-left">
                <i data-lucide="layout-dashboard" size="18"></i> Dashboard
            </button>
            <button onclick="switchTab('kas')" class="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-white/10 transition-all font-medium text-left">
                <i data-lucide="wallet" size="18"></i> Buku Kas
            </button>
        </nav>
        <div class="pt-6 border-t border-white/10">
            <button onclick="handleAuthAction()" id="auth-btn-desktop" class="w-full flex items-center gap-3 p-3 rounded-xl text-slate-400 hover:text-white transition-all text-left">
                <i data-lucide="user" size="18"></i> <span id="auth-label">Login Admin</span>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="p-6 lg:p-12 mt-16 lg:mt-0">
        <!-- Dashboard Section -->
        <section id="tab-dashboard" class="tab-content active space-y-8">
            <header>
                <h2 class="text-3xl font-extrabold text-slate-800">Ringkasan Kas</h2>
                <div id="connection-status" class="text-xs font-bold text-amber-500 mt-2 flex items-center gap-1">
                    <span class="relative flex h-2 w-2"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-amber-400 opacity-75"></span><span class="relative inline-flex rounded-full h-2 w-2 bg-amber-500"></span></span>
                    Menghubungkan ke Cloud...
                </div>
            </header>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100">
                    <p class="text-[10px] uppercase font-bold text-slate-400 mb-2">Pemasukan</p>
                    <p id="total-masuk" class="text-2xl font-bold text-emerald-600">Rp 0</p>
                </div>
                <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100">
                    <p class="text-[10px] uppercase font-bold text-slate-400 mb-2">Pengeluaran</p>
                    <p id="total-keluar" class="text-2xl font-bold text-rose-600">Rp 0</p>
                </div>
                <div class="bg-emerald-600 p-6 rounded-3xl shadow-lg text-white">
                    <p class="text-[10px] uppercase font-bold opacity-70 mb-2">Saldo Saat Ini</p>
                    <p id="total-saldo" class="text-2xl font-black">Rp 0</p>
                </div>
            </div>
        </section>

        <!-- Buku Kas Section -->
        <section id="tab-kas" class="tab-content space-y-6">
            <div class="flex items-center justify-between">
                <h2 class="text-2xl font-bold">Buku Kas</h2>
                <button onclick="openModal('tx-modal')" class="admin-only hidden bg-emerald-600 text-white px-5 py-2.5 rounded-2xl font-bold text-sm flex items-center gap-2">
                    <i data-lucide="plus" size="16"></i> Tambah Data
                </button>
            </div>
            <div class="bg-white rounded-3xl shadow-sm border border-slate-100 overflow-hidden">
                <table class="w-full text-left">
                    <thead class="bg-slate-50 border-b border-slate-100">
                        <tr class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">
                            <th class="p-6">Tanggal</th>
                            <th class="p-6">Keterangan</th>
                            <th class="p-6 text-right">Nominal</th>
                            <th class="admin-only hidden p-6 text-center">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="tx-table-body" class="divide-y divide-slate-50">
                        <!-- Data rows -->
                    </tbody>
                </table>
            </div>
        </section>
    </main>

    <!-- Modal Transaksi -->
    <div id="tx-modal" class="hidden fixed inset-0 z-50 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-[2rem] p-8 shadow-2xl">
            <h3 class="text-xl font-bold mb-6">Tambah Transaksi</h3>
            <form onsubmit="saveTransaction(event)" class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <input name="tgl" type="date" required class="p-3 bg-slate-50 rounded-xl border border-slate-100">
                    <select name="jenis" class="p-3 bg-slate-50 rounded-xl border border-slate-100">
                        <option value="Pemasukan">Pemasukan (+)</option>
                        <option value="Pengeluaran">Pengeluaran (-)</option>
                    </select>
                </div>
                <input name="uraian" placeholder="Uraian" required class="w-full p-3 bg-slate-50 rounded-xl border border-slate-100">
                <input name="nominal" type="number" placeholder="Nominal" required class="w-full p-3 bg-slate-50 rounded-xl border border-slate-100 font-bold">
                <div class="flex gap-4 pt-4">
                    <button type="button" onclick="closeModal('tx-modal')" class="flex-1 font-bold text-slate-400">Batal</button>
                    <button type="submit" class="flex-1 bg-emerald-600 text-white p-3 rounded-xl font-bold">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase Integration -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        /** * VARIABEL GLOBAL DARI SISTEM (BUKAN HARDCODED)
         * __firebase_config dan __app_id disediakan secara otomatis oleh sandbox environment.
         */
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            // Ini adalah tempat jika Anda ingin menaruh config manual di luar lingkungan sandbox
            apiKey: "AIzaSyAZHKit1-zjq_DAYOpQnf-3AIOwF7QVXlk",
            authDomain: "kasmasjidsm.firebaseapp.com",
            projectId: "kasmasjidsm",
            storageBucket: "kasmasjidsm.firebasestorage.app",
            messagingSenderId: "114589495617",
            appId: "1:114589495617:web:7d52f5f94dc847962a31c0",
        };
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'masjid-cloud-default';

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let user = null;
        let isAdmin = false;

        // --- AUTH FLOW ---
        const initAuth = async () => {
            try {
                // Gunakan custom token jika tersedia, jika tidak anonim
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (err) {
                console.error("Auth failed:", err);
            }
        };

        onAuthStateChanged(auth, (u) => {
            user = u;
            if (u) {
                isAdmin = !u.isAnonymous;
                document.getElementById('connection-status').innerHTML = '<span class="h-2 w-2 bg-emerald-500 rounded-full"></span> Terhubung ke Cloud';
                document.getElementById('connection-status').className = "text-[10px] font-bold text-emerald-500 mt-2 flex items-center gap-1";
                updateUIVisibility();
                startSync();
            } else {
                initAuth();
            }
        });

        // --- FIRESTORE SYNC ---
        function startSync() {
            if (!user) return;
            // RULE 1: Strict Pathing
            const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'transactions');
            
            onSnapshot(colRef, (snap) => {
                const data = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderTransactions(data);
            }, (error) => {
                console.error("Permission error:", error);
            });
        }

        function renderTransactions(data) {
            const table = document.getElementById('tx-table-body');
            let tIn = 0, tOut = 0;
            const fmt = (v) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(v);

            table.innerHTML = data.map(t => {
                const isMasuk = t.jenis === 'Pemasukan';
                const n = Number(t.nominal) || 0;
                if(isMasuk) tIn += n; else tOut += n;

                return `<tr>
                    <td class="p-6 text-sm text-slate-500">${t.tgl}</td>
                    <td class="p-6 font-bold uppercase text-sm">${t.uraian}</td>
                    <td class="p-6 text-right font-bold ${isMasuk ? 'text-emerald-600' : 'text-rose-600'}">${fmt(n)}</td>
                    <td class="admin-only ${isAdmin ? '' : 'hidden'} p-6 text-center">
                        <button onclick="deleteTx('${t.id}')" class="text-rose-400 hover:text-rose-600"><i data-lucide="trash-2" size="16"></i></button>
                    </td>
                </tr>`;
            }).join('');

            document.getElementById('total-masuk').innerText = fmt(tIn);
            document.getElementById('total-keluar').innerText = fmt(tOut);
            document.getElementById('total-saldo').innerText = fmt(tIn - tOut);
            lucide.createIcons();
        }

        window.saveTransaction = async (e) => {
            e.preventDefault();
            if(!user) return;
            const fd = new FormData(e.target);
            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'transactions'), {
                    tgl: fd.get('tgl'),
                    jenis: fd.get('jenis'),
                    uraian: fd.get('uraian'),
                    nominal: Number(fd.get('nominal')),
                    uid: user.uid
                });
                closeModal('tx-modal');
                e.target.reset();
            } catch (err) { alert("Gagal menyimpan: " + err.message); }
        };

        window.deleteTx = async (id) => {
            if(!confirm("Hapus?")) return;
            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'transactions', id));
        };

        function updateUIVisibility() {
            document.querySelectorAll('.admin-only').forEach(el => isAdmin ? el.classList.remove('hidden') : el.classList.add('hidden'));
            document.getElementById('auth-label').innerText = isAdmin ? "Logout Admin" : "Login Admin";
        }

        // Global Helpers
        window.switchTab = (id) => {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById(`tab-${id}`).classList.add('active');
        };
        window.openModal = (id) => document.getElementById(id).classList.remove('hidden');
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
        window.handleAuthAction = () => isAdmin ? signOut(auth) : openModal('login-modal'); // Simplified login for demo

        lucide.createIcons();
    </script>
</body>
</html>
